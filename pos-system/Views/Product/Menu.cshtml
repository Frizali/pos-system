@{
    Layout = "~/Views/Shared/_OrderLayout.cshtml";
    ViewData["Title"] = "Menu";
}

@model MenuViewModel

<link rel="stylesheet" href="~/css/Product/index.css" asp-append-version="true" />

<div class="container">
    <form asp-action="Menu" asp-controller="Product" method="get">
        @Html.Partial("_ProductCategory", Model.ProductCategories)
        <div class="mb-3">
            <div class="input-group flex-nowrap">
                <input type="text" class="form-control search-input" placeholder="Search menu" aria-label="Search menu" aria-describedby="addon-wrapping" name="product">
                <span class="input-group-text search-input-icon" id="addon-wrapping">
                    <div class="search-icon bg-light">
                        <i class="bi bi-search"></i>
                    </div>
                </span>
            </div>
        </div>
    </form>
    <div>
        <div>
            <div class="row g-3">
                @foreach (var item in Model.Products)
                {
                    <div class="col-md-4 col-sm-12 col-xl-3">
                        <div class="card clickable-card h-100 border-0" data-id="@item.ProductId" style="cursor: pointer;">
                            <div class="card-body">
                                <div>
                                    <img src="~/images/egg-tarts.jpg" class="w-100"/>
                                </div>
                                <h6 class="card-title m-0">@item.ProductName</h6>
                                <div class="d-flex flex-md-column flex-xl-row justify-content-between">
                                    <p class="card-text m-0">@item.Category.CategoryName</p>
                                    <b>
                                        <p class="card-text">
                                            @{
                                                var priceText = String.Empty;
                                                if (item.TblProductVariants.Count() > 1)
                                                {
                                                    var lowPrice = item.TblProductVariants.Min(x => x.VariantPrice);
                                                    var hightPrice = item.TblProductVariants.Max(x => x.VariantPrice);
                                                    priceText = $"Rp{lowPrice}-{hightPrice}";
                                                }
                                                else if (item.TblProductVariants.Count() == 1)
                                                {
                                                    var price = item.TblProductVariants.Select(x => x.VariantPrice).FirstOrDefault();
                                                    priceText = $"Rp{price}";
                                                }
                                                else
                                                {
                                                    priceText = $"Rp{item.Price}";
                                                }
                                            }
                                            @priceText
                                        </p>
                                    </b>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<form asp-action="AddOrderItem" asp-controller="Product" method="post">
    <div class="modal fade" id="productDetailModal" tabindex="-1" role="dialog" aria-labelledby="productDetailModalLabel" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content modal-menu border-0">
                <div class="modal-header">
                    <h6 class="modal-title text-center" id="productDetailModalLabel">Product Detail</h6>
                    <button type="button" class="close border-0" data-dismiss="modal" aria-label="Close" id="product-detail-close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="productModalBody">
                </div>
                <div class="modal-footer p-0 border-top-0">
                    <div class="container">
                        <div class="row">
                            <div class="col-12">
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-default btn-number" data-type="minus" data-field="Quantity">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                    </span>
                                    <input type="text" id="Quantity" name="Quantity" class="form-control input-number text-center border-white" value="1" min="1" max="9999">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-default btn-number" data-type="plus" data-field="Quantity">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary btn-add-cart m-0 w-100" data-dismiss="modal" id="add-cart" disabled>Add to Cart<span id="priceContainer"></span></button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    const variants = @Html.Raw(Json.Serialize(Model.Products.SelectMany(x => x.TblProductVariants).Select(v => new
        {
            id = v.VariantId,
            productId = v.ProductId,
            sku = v.Sku,
            price = v.VariantPrice
        })));

    const products = @Html.Raw(Json.Serialize(Model.Products.Select(x => new
        {
            id = x.ProductId,
            stock = x.ProductStock,
            price = x.Price
        })));
</script>

<script>
    let selected = {};
    let menuPrice = 0;

    $(document).on('click', '.variant-option-tag', function () {
        const value = $(this).data('value');
        const group = $(this).data('group');

        $(this).closest('.body-variant-group').find('.variant-option-tag').removeClass('option-selected');
        $(this).addClass('option-selected');

        selected[group] = value;

        var input = parseInt($("input[name='Quantity']").val());
        const totalGroups = $('.body-variant-group').length;
        if (Object.keys(selected).length === totalGroups) {
            const combined = Array.from({ length: totalGroups }, (_, i) => selected[i]).join('-');
            const match = variants.find(v => v.sku === combined);

            if (match) {
                menuPrice = match.price;
                const btnAddCart = $('#add-cart');
                btnAddCart.removeAttr("disabled");
                $('#priceContainer').text(' (Rp' + match.price * input + ')');
            } else {
                $('#priceContainer').text(' (-)');
            }
        }
    });

    const orderItems = [];

    $(document).on('click', '#add-cart', function(){
        const totalGroups = $('.body-variant-group').length;
        const totalSelected = $('.option-selected').length;
        const orderItemsContainer = $('#order-items');

        if(totalGroups == totalSelected){
            var selectedItem = [];
            $('.option-selected').each(function (index) {
                selectedItem.push($(this).text().trim());
            });

            const combined = selectedItem.join('-');
            const match = variants.find(v => v.sku.trim() === combined);
            const quantity = $('#Quantity').val();
            // $.post('/Product/AddOrderItem', { ProductID: match.productId, VariantID: match.id, Quantity: quantity }, function (data) {
            // })
            orderItems.push({
                ProductID: match.productId,
                VariantID: match.id,
                Quantity: quantity,
                UnitPrice: match.price,
                SubTotal: match.price * quantity
            });
        }
        orderItemsContainer.empty();
        orderItems.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'card mb-3 border-0 bg-light order-item-anim';
            itemElement.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-1 fw-bold">${item.ProductID}</h6>
                            <button class="btn btn-sm btn-outline-danger remove-item" data-id="${item.ProductID}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="input-group input-group-sm" style="width: 120px;">
                            <button class="btn btn-outline-secondary decrease-quantity" data-id="${item.ProductID}">
                                <i class="bi bi-dash"></i>
                            </button>
                                <span class="form-control text-center">${item.Quantity}</span>
                                <button class="btn btn-outline-secondary increase-quantity" data-id="${item.ProductID}">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                            <div class="text-primary fw-bold">Rp. ${item.SubTotal}</div>
                    </div>
                </div>
                `;
            orderItemsContainer.append(itemElement);
        });
    })
</script>


<script src="~/Views/Product/Menu.cshtml.js"></script>
