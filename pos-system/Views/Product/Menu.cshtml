@{
    Layout = "~/Views/Shared/_OrderLayout.cshtml";
    ViewData["Title"] = "Menu";
}

@model MenuViewModel

<link rel="stylesheet" href="~/css/Product/index.css" asp-append-version="true" />

<div class="container">
    <form asp-action="Menu" asp-controller="Product" method="get">
        @Html.Partial("_ProductCategory", Model.ProductCategories)
        <div class="mb-3">
            <div class="input-group flex-nowrap">
                <input type="text" class="form-control search-input" placeholder="Search something in your mind" aria-label="Search something in your mind" aria-describedby="addon-wrapping" name="product">
                <span class="input-group-text search-input-icon" id="addon-wrapping">
                    <div class="search-icon bg-light">
                        <i class="bi bi-search"></i>
                    </div>
                </span>
            </div>
        </div>
    </form>
    <div>
        <div>
            <div class="row g-3">
                @foreach (var item in Model.Products)
                {
                    <div class="col-md-4 col-sm-12 col-xl-2">
                        <div class="card clickable-card h-100 border-0" data-id="@item.ProductId" style="cursor: pointer;">
                            <div class="card-body d-flex flex-column justify-content-between">
                                <div>
                                    <img src="data:@item.ImageType;base64,@item.ProductImage" class="w-100" />
                                </div>
                                <div>
                                    <h6 class="card-title m-0">@item.ProductName</h6>
                                    <p class="text-muted m-0">@item.Category.CategoryName</p>
                                    <b>
                                        <p class="card-text">
                                            @{
                                                var priceText = String.Empty;
                                                if (item.TblProductVariants.Count() > 1)
                                                {
                                                    var lowPrice = item.TblProductVariants.Min(x => x.VariantPrice);
                                                    var hightPrice = item.TblProductVariants.Max(x => x.VariantPrice);
                                                    priceText = $"Rp{lowPrice}-{hightPrice}";
                                                }
                                                else if (item.TblProductVariants.Count() == 1)
                                                {
                                                    var price = item.TblProductVariants.Select(x => x.VariantPrice).FirstOrDefault();
                                                    priceText = $"Rp{price}";
                                                }
                                                else
                                                {
                                                    priceText = $"Rp{item.Price}";
                                                }
                                            }
                                            @priceText
                                        </p>
                                    </b>

                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<form asp-action="AddOrderItem" asp-controller="Product" method="post">
    <div class="modal fade" id="productDetailModal" tabindex="-1" role="dialog" aria-labelledby="productDetailModalLabel" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content modal-menu border-0">
                <div class="modal-header">
                    <h6 class="modal-title text-center" id="productDetailModalLabel">Product Detail</h6>
                    <button type="button" class="close border-0" data-dismiss="modal" aria-label="Close" id="product-detail-close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="productModalBody">
                </div>
                <div class="modal-footer p-0 border-top-0">
                    <div class="container">
                        <div class="row">
                            <div class="col-12">
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-default btn-number" data-type="minus" data-field="Quantity">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                    </span>
                                    <input type="text" id="Quantity" name="Quantity" class="form-control input-number text-center border-white" value="1" min="1" max="9999">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-default btn-number" data-type="plus" data-field="Quantity">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary btn-add-cart m-0 w-100" data-dismiss="modal" id="add-cart" data-id="" disabled>Add to Cart<span id="priceContainer"></span></button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    const variants = @Html.Raw(Json.Serialize(Model.Products.SelectMany(x => x.TblProductVariants).Select(v => new
        {
            id = v.VariantId,
            productId = v.ProductId,
            sku = v.Sku,
            price = v.VariantPrice
        })));

    const products = @Html.Raw(Json.Serialize(Model.Products.Select(x => new
        {
            id = x.ProductId,
            name = x.ProductName,
            stock = x.ProductStock,
            price = x.Price
        })));
</script>

<script>
    let selected = {};
    let menuPrice = 0;

    $(document).on('click', '.variant-option-tag', function () {
        const value = $(this).data('value');
        const group = $(this).data('group');

        $(this).closest('.body-variant-group').find('.variant-option-tag').removeClass('option-selected');
        $(this).addClass('option-selected');

        selected[group] = value;

        var input = parseInt($("input[name='Quantity']").val());
        const totalGroups = $('.body-variant-group').length;
        if (Object.keys(selected).length === totalGroups) {
            const combined = Array.from({ length: totalGroups }, (_, i) => selected[i]).join('-');
            const match = variants.find(v => v.sku === combined);

            if (match) {
                menuPrice = match.price;
                const btnAddCart = $('#add-cart');
                btnAddCart.removeAttr("disabled");
                $('#priceContainer').text(' (Rp' + match.price * input + ')');
            } else {
                $('#priceContainer').text(' (-)');
            }
        }
    });

    const orderItems = [];

    $(document).on('click', '#add-cart', function(){
        const totalGroups = $('.body-variant-group').length;
        const totalSelected = $('.option-selected').length;
        const orderItemsContainer = $('#order-items');
        const quantity = $('#Quantity').val();

        if(totalGroups == 0 && totalSelected == 0){
            var productId = $(this).data('id');
            const product = products.find(p => p.id == productId);

            orderItems.push({
                ProductID: product.productId,
                VariantID: "",
                Name: product.name,
                SKU: "",
                Quantity: quantity,
                UnitPrice: product.price,
                SubTotal: product.price * quantity
            });
        }else if(totalGroups == totalSelected){
            var selectedItem = [];
            $('.option-selected').each(function (index) {
                selectedItem.push($(this).text().trim());
            });

            const combined = selectedItem.join('-');
            const match = variants.find(v => v.sku.trim() === combined);
            const product = products.find(p => p.id == match.productId);
            // $.post('/Product/AddOrderItem', { ProductID: match.productId, VariantID: match.id, Quantity: quantity }, function (data) {
            // })
            orderItems.push({
                ProductID: match.productId,
                VariantID: match.id,
                Name: product.name,
                SKU: match.sku,
                Quantity: quantity,
                UnitPrice: match.price,
                SubTotal: match.price * quantity
            });
        }
        orderItemsContainer.empty();
        orderItems.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'card border-0 order-item-anim';
            itemElement.innerHTML = `
                <div class="card-bodyp-0">
                    <div class="d-flex gap-3 ">
                        <div style="width:15%">
                            <img src="/images/egg-tart.jpg" class="w-100"/>
                        </div>
                        <div>
                            <h6 class="card-title m-0">${item.Name} (${item.SKU})</h6>
                            <p class="text-muted m-0">Rp. ${item.SubTotal}</p>
                        </div>
                    </div>
                    <div class="input-group">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-default btn-number" data-type="minus" data-field="Quantity">
                                <i class="bi bi-dash"></i>
                            </button>
                        </span>
                        <input type="text" id="Quantity" name="Quantity" class="form-control input-number text-center border-white" value="${item.Quantity}" min="1" max="9999">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-default btn-number" data-type="plus" data-field="Quantity">
                                <i class="bi bi-plus"></i>
                            </button>
                        </span>
                    </div>
                </div>
                <hr />
                `;
            orderItemsContainer.append(itemElement);
        });

        $('#productDetailModal').modal('hide');
    })
</script>


<script src="~/Views/Product/Menu.cshtml.js"></script>
